<?xml version="1.0" encoding="utf-8"?>
<configuration>

	<location path="." inheritInChildApplications="false">
		<system.webServer>
			<handlers>
				<!-- ASP.NET Core handler -->
				<add name="aspNetCore" path="*" verb="*"
					 modules="AspNetCoreModuleV2" resourceType="Unspecified" />
			</handlers>

			<!-- ASP.NET Core hosting -->
			<aspNetCore processPath="dotnet"
						arguments=".\ApiGateway.dll"
						stdoutLogEnabled="true"
						stdoutLogFile=".\logs\stdout"
						hostingModel="inprocess" />
		</system.webServer>
	</location>

	<!-- Root-level IIS config -->
	<system.webServer>
		<!-- Enable WebSockets -->
		<webSocket enabled="true" />

		<!-- Rewrite rules -->
		<rewrite>
			<rules>
				<rule name="ChatHub WebSocket" stopProcessing="true">
					<match url="^chat/chathub/(.*)" />
					<conditions>
						<add input="{HTTP_CONNECTION}" pattern="Upgrade" ignoreCase="true" />
						<add input="{HTTP_UPGRADE}" pattern="websocket" ignoreCase="true" />
					</conditions>
					<action type="Rewrite" url="http://localhost:5002/chathub/{R:1}" />
				</rule>

				<rule name="AgentHub WebSocket" stopProcessing="true">
					<match url="^agent/agenthub/(.*)" />
					<conditions>
						<add input="{HTTP_CONNECTION}" pattern="Upgrade" ignoreCase="true" />
						<add input="{HTTP_UPGRADE}" pattern="websocket" ignoreCase="true" />
					</conditions>
					<action type="Rewrite" url="http://localhost:5001/agenthub/{R:1}" />
				</rule>
			</rules>

			<!-- Allow required headers -->
			<allowedServerVariables>
				<add name="HTTP_X_FORWARDED_FOR" />
				<add name="HTTP_X_FORWARDED_HOST" />
				<add name="HTTP_X_FORWARDED_PROTO" />
			</allowedServerVariables>
		</rewrite>
	</system.webServer>

</configuration>
